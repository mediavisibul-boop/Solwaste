import React, { useState, useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import { Navigation } from './Navigation';
import { MobileMenu } from './MobileMenu';

export const Layout: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [isScrolled, setIsScrolled] = useState(false);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isSlideDark, setIsSlideDark] = useState(true); // State for Home slide color
  const location = useLocation();
  
  const isHomePage = location.pathname === '/';

  useEffect(() => {
    const handleScroll = () => {
      setIsScrolled(window.scrollY > 40);
    };

    // Listen for slide change events from Home page
    const handleSlideChange = (e: Event) => {
      const customEvent = e as CustomEvent;
      if (customEvent.detail && typeof customEvent.detail.isDark !== 'undefined') {
        setIsSlideDark(customEvent.detail.isDark);
      }
    };

    window.addEventListener('scroll', handleScroll);
    window.addEventListener('solwaste-slide-change', handleSlideChange);

    return () => {
      window.removeEventListener('scroll', handleScroll);
      window.removeEventListener('solwaste-slide-change', handleSlideChange);
    };
  }, []);

  useEffect(() => {
    setIsMobileMenuOpen(false);
    
    // Check if there's a hash in the URL
    const hash = location.hash.replace('#', '');
    
    if (hash) {
      // If there's a hash, scroll to that element after a short delay
      setTimeout(() => {
        const element = document.getElementById(hash);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    } else {
      // No hash, scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Reset to dark nav (white text) by default when leaving home
    if (!isHomePage) {
        setIsSlideDark(false); 
    }
  }, [location, isHomePage]);

  // Dynamic Styles
  const isNavTransparent = isHomePage && !isScrolled;
  
  // Text Color Logic
  const textColorClass = isNavTransparent 
    ? (isSlideDark ? 'text-white' : 'text-brand-brown') 
    : 'text-brand-brown';

  return (
    <div className="flex flex-col min-h-screen font-sans overflow-x-hidden max-w-full bg-gray-50">
      {/* Global Animations Style Block */}
      <style>{`
            @keyframes marquee {
                0% { transform: translateX(0); }
                100% { transform: translateX(-50%); }
            }
            .animate-marquee {
                will-change: transform;
                animation: marquee 40s linear infinite;
            }
            @keyframes blink-glow {
                0%, 100% { opacity: 1; box-shadow: 0 0 5px rgba(190, 215, 84, 0.5); }
                50% { opacity: 0.6; box-shadow: 0 0 15px rgba(190, 215, 84, 0.9); }
            }
            .badge-blink {
                animation: blink-glow 1.5s ease-in-out infinite;
            }
      `}</style>
      
      {/* Main Navigation */}
      <nav 
        className={[
          "fixed w-full z-50 transition-all duration-500 ease-in-out",
          isNavTransparent
            ? "bg-transparent py-4 sm:py-5 md:py-6 lg:py-8" 
            : "bg-white/95 backdrop-blur-md shadow-sm py-3 sm:py-4 border-b border-gray-200"
        ].join(" ")}
      >
        <div className="container mx-auto px-3 xs:px-4 sm:px-6 flex justify-between items-center">
          <>
            {/* Logo - Clean design without borders */}
          <Link to="/" className="flex items-center gap-0.5 sm:gap-1 md:gap-1.5 group touch-manipulation">
            <img 
              src="/logo.png" 
              alt="Solwaste Logo" 
              className="w-8 h-8 xs:w-9 xs:h-9 sm:w-10 sm:h-10 md:w-11 md:h-11 lg:w-12 lg:h-12 object-contain transition-all duration-500"
            />
            <div className="flex flex-col leading-none select-none">
              <span className="text-lg xs:text-xl sm:text-2xl md:text-2xl lg:text-3xl font-heading font-bold tracking-tighter transition-colors duration-500">
                <span className={(isNavTransparent && !isScrolled) ? 'text-white' : 'text-brand-brown'}>SOL</span><span className="text-brand-gold">WASTE</span>
              </span>
            </div>
          </Link>

          {/* Desktop Nav - Enhanced color coordination */}
          <>
          <div className="hidden md:flex items-center gap-4 lg:gap-6 xl:gap-8 2xl:gap-10">
            {/* OWC Link */}
            <Link
                to="/owc"
                className={[
                  "font-heading font-bold text-sm lg:text-base uppercase tracking-[0.15em]",
                  "hover:text-brand-gold active:text-brand-gold transition-all duration-300 relative group",
                  isNavTransparent ? "text-white" : "text-brand-brown"
                ].join(" ")}
            >
                OWC
                <span className="absolute bottom-0 left-0 w-0 h-0.5 bg-brand-gold group-hover:w-full transition-all duration-300"></span>
            </Link>

            {/* Fahaka Special Button-Link */}
             <Link
                to="/fahaka"
                className={[
                  "font-heading font-bold text-sm lg:text-base uppercase tracking-[0.15em]",
                  "transition-all duration-300 flex items-center gap-2 group",
                  isNavTransparent ? "text-white" : "text-brand-brown"
                ].join(" ")}
            >
                <span className="relative px-2.5 py-1 text-[10px] font-bold rounded-md bg-[#FF0000] text-white badge-blink shadow-md shadow-[#FF0000]/30">
                  NEW
                </span>
                <span className="group-hover:text-brand-gold transition-colors relative">
                  Fahaka
                  <span className="absolute bottom-0 left-0 w-0 h-0.5 bg-brand-gold group-hover:w-full transition-all duration-300"></span>
                </span>
            </Link>

            {/* Get Quote Button */
            <Link to="/contact">
              <Button 
                className={[
                  "min-h-[42px] md:min-h-[44px] lg:min-h-[46px]",
                  "px-4 md:px-6 lg:px-8 py-2 md:py-2.5",
                  "text-xs md:text-sm uppercase tracking-widest font-heading font-bold",
                  "shadow-lg hover:shadow-xl active:shadow-md",
                  "transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0",
                  "touch-manipulation",
                  isNavTransparent 
                    ? "bg-brand-gold text-white border-brand-gold hover:bg-white hover:text-brand-gold hover:border-white" 
                    : "bg-brand-gold text-white border-brand-gold hover:bg-brand-dark hover:text-white hover:border-brand-dark"
                ].join(" ")}
              >
                Get Quote
              </Button>
            </Link>
          </div></>

          <button 
            className={[
              "md:hidden min-w-[48px] min-h-[48px] p-3 flex items-center justify-center",
              "transition-all duration-300 touch-manipulation active:scale-95",
              textColorClass,
              isNavTransparent 
                ? "hover:bg-white hover:bg-opacity-10 active:bg-white active:bg-opacity-20" 
                : "hover:bg-gray-100 active:bg-gray-200",
              "rounded-lg"
            ].join(" ")}
            onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
            aria-label={isMobileMenuOpen ? "Close Menu" : "Open Menu"}
            aria-expanded={isMobileMenuOpen}
          >
            {isMobileMenuOpen ? (
              <X size={24} className="xs:w-6 xs:h-6 sm:w-7 sm:h-7" />
            ) : (
              <Menu size={24} className="xs:w-6 xs:h-6 sm:w-7 sm:h-7" />
            )}
          </button></>
        </div>
          "transition-all duration-300 ease-in-out origin-top",
          isMobileMenuOpen ? "max-h-screen opacity-100 visible" : "max-h-0 opacity-0 invisible"
        ].join(" ")}>
          <div className="container mx-auto px-4 xs:px-5 sm:px-6">
            <nav className="flex flex-col p-4 xs:p-5 sm:p-6 md:p-8 space-y-2 xs:space-y-3 sm:space-y-4" role="navigation" aria-label="Mobile navigation">
            <Link 
              to="/" 
              onClick={() => setIsMobileMenuOpen(false)} 
              className="min-h-[48px] flex items-center justify-center text-base xs:text-lg sm:text-xl font-heading font-bold uppercase tracking-wider text-brand-brown hover:text-brand-gold active:text-brand-gold transition-all duration-200 py-3 xs:py-3.5 px-4 rounded-lg hover:bg-brand-light/50 active:bg-brand-light active:scale-98 touch-manipulation"
            >
              Home
            </Link>
            <Link 
              to="/owc" 
              onClick={() => setIsMobileMenuOpen(false)} 
              className="min-h-[48px] flex items-center justify-center text-base xs:text-lg sm:text-xl font-heading font-bold uppercase tracking-wider text-brand-brown hover:text-brand-gold active:text-brand-gold transition-all duration-200 py-3 xs:py-3.5 px-4 rounded-lg hover:bg-brand-light/50 active:bg-brand-light active:scale-98 touch-manipulation"
            >
              OWC Machines
            </Link>
            <Link 
              to="/fahaka" 
              onClick={() => setIsMobileMenuOpen(false)} 
              className="min-h-[48px] flex items-center justify-center text-base xs:text-lg sm:text-xl font-heading font-bold uppercase tracking-wider text-brand-gold bg-brand-light hover:bg-brand-gold hover:text-white active:bg-brand-gold/90 transition-all duration-200 py-3 xs:py-3.5 px-4 rounded-lg active:scale-98 touch-manipulation relative"
            >
              Fahaka 
              <span className="text-[10px] xs:text-xs bg-[#FF0000] text-white px-2 py-1 rounded ml-2 badge-blink font-bold absolute -top-1 -right-1">NEW</span>
            </Link>
            <div className="pt-2">
              <Link to="/contact" onClick={() => setIsMobileMenuOpen(false)} className="block">
                  <Button className="w-full min-h-[52px] uppercase font-heading py-4 xs:py-4.5 sm:py-5 text-base xs:text-lg sm:text-xl font-bold shadow-lg hover:shadow-xl active:scale-98 transition-all touch-manipulation">
                    Get Quote
                  </Button>
              </Link>
            </div>
            </nav>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="flex-grow">
        {children}
      </main>

      {/* Industry Level Footer - Updated Spacing & Contrast */}
      <footer className="relative bg-brand-dark text-white pt-12 sm:pt-16 md:pt-20 pb-8 sm:pb-10 overflow-hidden border-t border-gray-800">
        
        {/* Marquee Background */}
        <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none opacity-[0.03] z-0 flex items-center select-none">
             <div className="whitespace-nowrap animate-marquee flex">
                <span className="text-[15vw] font-heading font-black text-white leading-none mx-8">WASTE REVOLUTION • ZERO LANDFILL •</span>
                <span className="text-[15vw] font-heading font-black text-white leading-none mx-8">WASTE REVOLUTION • ZERO LANDFILL •</span>
                <span className="text-[15vw] font-heading font-black text-white leading-none mx-8">WASTE REVOLUTION • ZERO LANDFILL •</span>
             </div>
        </div>

        <div className="container mx-auto px-4 xs:px-5 sm:px-6 relative z-10">
          <div className="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-6 xs:gap-7 sm:gap-8 lg:gap-10 xl:gap-12 mb-10 sm:mb-12 md:mb-14 lg:mb-16 border-b border-gray-800 pb-8 sm:pb-10 md:pb-12 lg:pb-14">
            
            {/* Column 1: Contact Info */}
            <div className="space-y-4 sm:space-y-6">
              <div className="space-y-2">
                 <a href="tel:+919429691308" className="block text-white font-heading font-bold text-xl sm:text-2xl tracking-wide hover:text-brand-gold transition-colors">+91-9429691308</a>
                 <a href="mailto:hello@solwaste.co" className="block text-white font-heading font-bold text-xl sm:text-2xl tracking-wide hover:text-brand-gold transition-colors break-all">hello@solwaste.co</a>
                 <p className="text-gray-300 text-base sm:text-lg leading-relaxed mt-4 font-medium">
                   Worli, 1st floor, 264-265, <br/>
                   Dr. Annie Besant Road, <br/>
                   Worli, Mumbai, MH 400025
                 </p>
              </div>
              <div className="flex space-x-4 sm:space-x-5 pt-2">
                 <a href="https://www.instagram.com/solwaste?igsh=MXVsMXVpMmZkOWh3Yg==" target="_blank" rel="noopener noreferrer" className="text-gray-400 hover:text-brand-gold transition-colors transform hover:-translate-y-1 duration-300 touch-manipulation" aria-label="Instagram">
                     <Instagram size={22} className="sm:w-6 sm:h-6" />
                 </a>
                 <a href="https://x.com/SolwasteCo" target="_blank" rel="noopener noreferrer" className="text-gray-400 hover:text-brand-gold transition-colors transform hover:-translate-y-1 duration-300 touch-manipulation" aria-label="X (Twitter)">
                     <X size={22} className="sm:w-6 sm:h-6" />
                 </a>
                 <a href="https://www.linkedin.com/company/solwaste/" target="_blank" rel="noopener noreferrer" className="text-gray-400 hover:text-brand-gold transition-colors transform hover:-translate-y-1 duration-300 touch-manipulation" aria-label="LinkedIn">
                     <Linkedin size={22} className="sm:w-6 sm:h-6" />
                 </a>
                 <a href="#" className="text-gray-400 hover:text-brand-gold transition-colors transform hover:-translate-y-1 duration-300 touch-manipulation" aria-label="Youtube">
                     <Youtube size={22} className="sm:w-6 sm:h-6" />
                 </a>
              </div>
            </div>

            {/* Column 2 - Left Row */}
            <div className="lg:pl-8">
              <ul className="space-y-2 sm:space-y-3 font-heading font-medium text-base sm:text-lg text-gray-400">
                {[
                  { name: 'Blog', path: '#' },
                  { name: 'Sustainability', path: '/sustainability' },
                  { name: 'Vision 2047', path: '/vision-2047' }
                ].map((item) => (
                  <li key={item.name}>
                    <Link 
                        to={item.path} 
                        className="hover:text-white transition-colors block touch-manipulation py-1"
                    >
                        {item.name}
                    </Link>
                  </li>
                ))}
              </ul>
            </div>

            {/* Column 3 - Middle Row */}
            <div>
              <ul className="space-y-2 sm:space-y-3 font-heading font-medium text-base sm:text-lg text-gray-400">
                {[
                  { name: 'Case Studies', path: '/case-studies' },
                  { name: 'Gallery', path: '/gallery' },
                  { name: 'Contact', path: '/contact' }
                ].map((item) => (
                  <li key={item.name}>
                    <Link 
                        to={item.path} 
                        className="hover:text-white transition-colors block touch-manipulation py-1"
                    >
                        {item.name}
                    </Link>
                  </li>
                ))}
              </ul>
            </div>

             {/* Column 4 - Right Row */}
             <div>
              <ul className="space-y-2 sm:space-y-3 font-heading font-medium text-base sm:text-lg text-gray-400">
                {[
                  { name: 'Press and Media', path: '/press-media' },
                  { name: 'Partner with us', path: '/partner' },
                  { name: 'Careers', path: '/careers' }
                ].map((item) => (
                  <li key={item.name}>
                     <Link 
                        to={item.path} 
                        className="hover:text-white transition-colors block touch-manipulation py-1"
                     >
                        {item.name}
                    </Link>
                  </li>
                ))}
              </ul>
            </div>

          </div>
          
          {/* Bottom Bar */}
          <div className="flex flex-col md:flex-row justify-between items-center text-gray-400 text-xs sm:text-sm font-medium gap-3 xs:gap-4 sm:gap-5 md:gap-6">
            <div className="flex flex-wrap justify-center gap-3 xs:gap-4 sm:gap-5 md:gap-6">
               <Link to="/privacy-policy" className="hover:text-brand-gold transition-colors touch-manipulation py-1">Privacy Policy</Link>
               <Link to="/accessibility-statement" className="hover:text-brand-gold transition-colors touch-manipulation py-1">Accessibility Statement</Link>
               <Link to="/sitemap" className="hover:text-brand-gold transition-colors touch-manipulation py-1">Sitemap</Link>
            </div>
            <div className="tracking-wide text-center text-gray-400">
               &copy; 2026 Solwaste. All rights reserved.
            </div>
          </div>
        </div>
      </footer>
    </div>
  );
};